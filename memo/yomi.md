# 読み上げ

　HTML文書を読み上げたい場合がある。たとえば視覚障害者がサイトを閲覧するために、その内容をTTS（Text to Speach）機能にて読み上げたい場合がある。

　HTMLはアクセシビリティ用にマークアップする機能が用意されている。それらは「アクセシビリティ」「ARIA」「A11y」といったキーワードで技術体系について調べることができる。

* https://zenn.dev/toono_f/scraps/762ba6e5235539
* https://qiita.com/AraiShg17/items/30c6c5545d269c24e8bb

　アクセシビリティ四原則

1. 知覚可能（五感：視覚、聴覚、触覚、味覚、嗅覚）
2. 操作可能（キーボード、マウス、タッチ、ゲームパッド）
3. 理解可能（意味付け）
4. 堅牢性

　A11yは複雑であるため、今回は対象外とする。

　今回は日本語文章、特にその小説に限定する。つまりテキスト主体であり、HTMLの`<ruby>`や`<em>`がある場合の文書を対象とする。

　読み上げの要件に関しては、その必要性を認める。特に今回は`<ruby>`要素を含めたHTML文書の読み上げについて注目したい。

　`<ruby>`要素に関しては、読み上げの前にルビ文字の表示是非を切り替える機能が欲しい。

　まずルビを振る時に考慮することがある。

1. すべての漢字などにルビを最大限振る
2. 日本人にとっても一般的でない難解な漢字にだけルビを振る
3. ルビを一切振らない

　読む人の識字力によって最適なルビ表示が変わる。そのためコンテンツとしては最大限にルビを振りつつも、その表示はユーザによって切り替えできるようにするのがベターだろう。

　ルビ文字として入力するのは、読み仮名と義訓の二種類ある。

1. ルビとして読み仮名を入力する
1. ルビとして義訓を入力する

　これらを適切に表示したい。

1. すべての漢字に読み仮名を表示する
2. 難解な漢字にのみ読み仮名を表示する
3. 義訓があれば表示する

　このとき読み仮名と義訓の両方を表示する場合もある。

1. 読み仮名のみ表示する
2. 義訓のみ表示する
3. 読み仮名と義訓の両方を表示する

　さらにその表示順序は以下のパターンがある。

1. 読み仮名が先、義訓が後
2. 義訓が先、読み仮名が後

　順序はさておき、表示する内容を限定したいこともあり、以下のようなパターンがありうる。

1. 親文字のみ表示する
2. 読み仮名のみ表示する
3. 義訓のみ表示する
4. 親文字＋読み仮名を表示する
5. 親文字＋義訓を表示する
6. 親文字＋読み仮名＋義訓を表示する

　読み上げのときは2の「読み仮名のみ表示する」パターンの`textContent`を取得できれば、そのまま読み上げツールに渡して音声を得られそうである。

　ただし両面ルビがあった場合、次のような読み上げパターンがありうる。

1. 親文字、読み仮名、義訓のいずれかのみ読み上げる
2. 親文字、読み仮名、義訓のすべてを読み上げる

　また、読み上げのタイミングに関しては、順序や同時などのパターンもありうる。

1. 親文字、読み仮名、義訓を順番に読み上げる
2. 親文字、読み仮名、義訓を同時に読み上げる

　同時読み上げは普通しないが、呪文の詠唱でわざと副音声のように聞かせるような演出として、やりたい場合もありうる。

　読み上げ対象はふつう読み仮名である。親文字は普通、読み仮名をもって読み上げたこととする。ただし場合によっては読み方の異なる別の表記をすることもあるかもしれない。あるいは音声合成に親文字と読み仮名の両方を渡したい場合があるかもしれない。

　これらを一つの構文で[DRY][]に表記したい。そのための構文を考えると、たとえば以下のようなものがありうる。

[DRY]:https://ja.wikipedia.org/wiki/Don%27t_repeat_yourself

```html
<ruby base="親文字" yomi="読み仮名" gikun="義訓"></ruby>
```
```
｜親文字《読み仮名｜義訓》
```
```
｜親文字《読み仮名》
```
```
｜親文字《｜義訓》
```

　ルビを動的に分割したい場合がある。行末で自動折返しがしたい時だ。

　`<ruby>`は自動折返しできない。この制限のおかげで基本的には読みやすくなるが、長いルビ要素の場合は途中で折り返したいこともありうる。

　たとえば以下のように長い文字が折り返せないと、前の行の最後の空白がそれだけ大きくなってしまう。それが読みにくさや違和感になってしまいかねない。

```
邪王炎殺黒龍波
```
```
一文字ずつ表示すれば本来はここが行末
でもルビ文字が長すぎると
邪王炎殺黒龍波
```

　分割位置によって意味が変わってしまいそうな場合もある。

```
京都市
京,都市
京都,市
京,都,市
```

　そのため分割位置を指定できたほうが親切である。

```html
<ruby base="京都市" yomi="きょう,と,し" gikun="" break="3,2+1" ></ruby>
```
```
京都市   ○
京都,市  ○
京,都市  ❌
京,都,市 ❌
```

　ちなみに`yomi`は親文字一字ずつに対してカンマを振る。これを`break`で指定するなら`yomi`,`mono`,`1+1+1`で可能。

```html
<ruby base="京都市" yomi="きょう,と,し" gikun="" break="3,2+1,1+2,1+1+1" ></ruby>
```
```html
<ruby base="京都市" yomi="きょう,と,し" gikun="" break="3,2+1,1+2,yomi" ></ruby>
```
```html
<ruby base="京都市" yomi="きょう,と,し" gikun="" break="3,2+1,1+2,mono" ></ruby>
```
```html
<ruby base="京都市" yomi="きょう,と,し" gikun="" break="all,2+1,1+2,mono" ></ruby>
```
```html
<ruby base="京都市" yomi="きょう,と,し" gikun="" break="group,2+1,1+2,mono" ></ruby>
```
```
京都市   ○
京都,市  ○
京,都市  ○
京,都,市 ○
```
```
｜京都市《きょう,と,し：3,2+1》
```

　ただし義訓があれば、おそらく分割できない。義訓は大抵グループルビであり親文字全体に対して一つのルビであり、分割できないから。

　両面ルビの場合、読み仮名と義訓、どれか一つでもグループルビがあれば分割不能である。

　分割可能なのは、義訓がなく読み仮名だけがあり、かつ読み仮名が一字ずつ分割されている場合だ。さらに分割点が指定されている場合は、分割の必要に応じて、なるだけ少ない分割で済ませようとする。

　もしHTMLを書くなら実際には`data-*`属性にするとよい。これなら任意の名前を作れる。

```html
<ruby data-base="京都市" data-yomi="きょう,と,し" data-gikun="" data-break="group,2+1,1+2,mono">
```

　もし可能ならWebComponentを自作すると良い。要素名は日本語にローカライズされていることを意識させるため言語コード`ja`を含める。ついでに`ruby`は長いため`rb`に省略する。これは旧`<rb>`であり`ruby-base`（親文字）を意味するようにも見えてしまうから微妙かもしれないが。

```html
<ja-rb base="京都市" yomi="きょう,と,し" gikun="" break="group,2+1,1+2,mono">
```
```html
<ja-ruby base="京都市" yomi="きょう,と,し" gikun="" break="group,2+1,1+2,mono">
```

　ルビ文字の表示是非を切り替える。

```html
<ja-ruby base="超電磁砲" yomi="ちょう,でん,じ,ほう" gikun="レールガン" level="0">
```

　ルビ文字のうち読み仮名の表示是非を切り替える。これを制御するために`level`属性を用いる。

`level`|意味
-------|----
`0`|ルビ文字のうち読み仮名を表示しない
`1`|表示する（造語・専門用語・難しく珍しい人名など、ルビがなければ読めない）
`2`|表示する（日本人でも識字率が低そう）
`3`|表示する（日本人の識字率はある程度ありそうだが念の為に）
`4`|表示する（日本の義務教育レベルであり冗長になりそうだが児童や生徒のために）
`5`|表示する（外国人における日本語初学者のために。さらにローマ字による表示も？）

`level`|意味
-------|----
`0`|ルビ文字のうち義訓を表示しない
`1`|表示する（義訓と読み仮名がある場合は、義訓を隠して読み仮名だけを表示する）
`2`|表示する（義訓と読み仮名がある場合は、読み仮名を隠して義訓だけを表示する）
`3`|表示する（読み仮名の有無に関わらず、絶対に義訓を表示する）

　読み仮名と義訓のレベルはそれぞれの属性値の末尾につけることで指示できるようにしてもいい。

```html
<ja-ruby base="超電磁砲" yomi="ちょう,でん,じ,ほう:4" gikun="レールガン:2">
```
```
↓超電磁砲《ちょう,でん,じ,ほう:4｜レールガン:2》
```
```
↓超電磁砲《ちょう,でん,じ,ほう:-｜レールガン:+》
```
```
↓超電磁砲《ちょう,でん,じ,ほう:min｜レールガン:max》
```

　著者はこの基準でレベリングする。ただしこれに客観的で明確な指標は存在しないため、主観で適当にレベリングすることになる。おそらくJIS第二水準や、常用漢字一覧などが基準になる。

　読者はこのレベリングに応じて表示するルビを選別できる。

1. [`0`〜`5`]以下の読み仮名を表示する（それより小さいレベルの読み仮名は表示しない）
1. [`0`〜`3`]以下の義訓を表示する（それより小さいレベルの義訓は表示しない）

　`5`以下ならすべて表示する。`0`以下ならすべて隠す。

```
↓超電磁砲《ちょう,でん,じ,ほう:min｜レールガン:max：4,1+2+1》
```

　読み仮名については、外国人の初学者向けにローマ字表記する場合もありうる。

* ひらがな
* カタカナ
* ローマ字（ヘボン式・日本式・訓令式）
* 発音記号（国際音声記号（IPA））

　上から順に下へいくほど国際化され標準化される。日本語には発音記号がないが、国際音声記号（IPA）を使うことができる。これに対応する音声合成ソフトなら読み上げも可能なはず。

```
↓超電磁砲《ちょう,でん,じ,ほう:min｜レールガン:max：4,1+2+1 IPA:tɕʲiʲonɯllʲoɯdeɴʑihoɯ》
```

* https://autocvvctool.web.fc2.com/JAtoIPA/
* https://qiita.com/Reng/items/1db0c798972fc041aff5
* https://github.com/amanoese/kana2ipa

* https://openl.io/translate/international-phonetic-alphabet
    * https://unalengua.com/ipa-translate?ttsLocale=en-GB-WLS&voiceId=Geraint&text=hello
* http://ipa-reader.xyz/

　IPAで日本語を読み上げることは難しそう。素直に日本語の漢字、ひらがな、カタカナで日本語用の読み上げソフトを使ったほうが精度も高く自然な音声が得られる。

　読み仮名や義訓で置換した、読み上げ用テキストを生成するのが無難か。その場合、読み取り形式は、簡易構文またはHTMLになる。

　プレーンテキストに変換する場合、次の二通りありえる。

* 読み上げ用テキスト
* 読書用プレーンテキスト

　読書用はルビを"漢字（かんじ）"のように表記する。

　読み上げ用は"かんじ"のように読み仮名で置換する。もしくは親文字だけ、読み仮名だけ、のニパターンのファイルを出力する。あるいは義訓やそれらを同時または順序指定での読み上げなどを考慮したテキストを出力する。

　読み上げツールによって様々な制限や詳細設定をする場合が考えられる。

```
一回あたり100字までの制限がある。
もし一文あたりがそれ以上なら、
句読点で区切ったり、
文節で区切る必要がある。
それらを一行ずつ出力する。
あとは読み上げツールにて一行ずつ音声を生成して
それを再生するだけ。
途中で止めたり再開するのはコマンドラインでは不可能。
APIにしないと不可能。
無料で無制限でサーバとやりとりせずどのOSでも使えるものは未だにない。
```

　ルビには「モノ」と「グループ」の二種類ある。

ルビ|違い
----|----
モノルビ|親文字一字ずつにルビを振る
グループルビ|複数の親文字に対してルビを振る

[ruby-position]:https://developer.mozilla.org/ja/docs/Web/CSS/ruby-position
[ruby-align]:https://developer.mozilla.org/ja/docs/Web/CSS/ruby-align

