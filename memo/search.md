# ルビとテキスト検索

　ルビ要素と他のテキストを合わせてテキスト検索することができない問題がある。

　たとえば以下の場合「山田」や「やまだ」でテキスト検索してもヒットしない。「山」「田」「やま」「だ」のみヒットする。

<ruby>山<rt>やま</rt>田<rt>だ</rt><ruby>

```html
<ruby>山<rt>やま</rt>田<rt>だ</rt><ruby>
```

　「山」で検索した中から「山田」を目視で探すことも可能だが、本文中に「山田」ではない「山」の部分が大量にあり、特定する労力が甚大になってしまう場合がある。よって是非とも要素を跨いだテキスト検索を可能にしたい。

　この問題により`<ruby>`要素が使えない場面がある。以下要素は表示、検索、SEOの観点から`<ruby>`を使うべきでない。できれば使いたいのに使えない。極めてもどかしい状況である。

```html
<title></title>
<h1></h1>
```

# 解決案

1. [window.find()][] ※非標準
2. [setSelectionRange()][] ※input要素のみ
3. [テキストフラグメント][] ※要素間は跨げない
4. アンカー ※自力実装

## 1. [window.find()][] 

　非標準である。そもそも要素を跨いだ検索はできない。

[window.find()]:https://developer.mozilla.org/ja/docs/Web/API/Window/find

## 2. [setSelectionRange()][]

　[Selection][]を使って範囲選択する。[setSelectionRange()][]で範囲指定する。

[Selection]:https://developer.mozilla.org/ja/docs/Web/API/Selection
[setSelectionRange()]:https://developer.mozilla.org/ja/docs/Web/API/HTMLInputElement/setSelectionRange

```html
<ruby>山<rt>やま</rt>田<rt>だ</rt><ruby>
```

　ただし、input要素のみでしか使えないため、今回の用途には使えない。

## 3. [テキストフラグメント][]

[テキストフラグメント]:https://developer.mozilla.org/ja/docs/Web/URI/Fragment/Text_fragments

　URL内で任意テキスト部分を指定する。

```
https://example.com#:~:text=[prefix-,]textStart[,textEnd][,-suffix]
```
```
#:~:text=山田
```

　ただし、ルビ要素で区切られたら連続した文字列としてヒットしない。

　要素の区切りを跨いだ検索ができない。

https://github.com/ytyaru/Html.TextFragment.20231127185823

## 4. アンカー

```html
<h1>目次</h1>
<a href="#title-1">表題</a>

<h1 id="title-1">表題</h1>
```

　要素を跨いだテキスト検索をするなら、次のような流れになる。

1. 検索するテキストを入力する
2. `<ruby>`要素のうち親文字だけのパターンとルビ文字だけのパターンの全文書プレーンテキストを用意する
3. 2でテキスト検索する
4. 3でヒットしたら、その元となるHTMLの対象位置に`<mark id="...">`要素を挿入する
5. `id="..."`をアンカーとして`<a href="#...">`で検索部分へ飛ぶようにする


```html
<mark id="text-search-res-1">あ<ruby>...</ruby>い</mark>
```
```html
<a href="text-search-res-1">検索結果1</a>
```

　この方法で問題になるのは対象位置である。テキスト検索した位置とHTML位置をどう一致判定させるかが問題だ。

```
あ<ruby>山<rt>やま</rt>田<rt>だ</rt><ruby>い
```
```
あ山田い
```
```
あやまだい
```

　このとき「山田」または「やまだ」で検索してヒットさせたい。親文字とルビ文字でそれぞれテキスト化したらヒットできる。ただし、その後、HTML元の位置に`<mark>`を挿入したいが、それがHTMLのどの位置であるかの判定が難しい。

　もしHTML内でヒットすれば要素を跨がずに済んだ証である。だが今回は`<ruby>`要素を跨いだ検索がしたい。「あ山」「田い」でもヒットさせたい。要素を跨いでいるため、既存のテキスト検索では不可能だ。

　とりあえずテキスト検索については次の三段階で実行する。

1. HTMLテキストで検索する
2. 親文字化テキストで検索する
3. ルビ文字化テキストで検索する

　1は普通のテキスト検索だ。2,3は要素を跨いだテキスト検索である。

　要素を跨いだテキスト検索は負荷が大きい。そこでまずはルビ要素内のみに限って検索してみると良いかもしれない。

1. 一つの`<ruby>`要素内にある親文字内のみ検索する
2. 一つの`<ruby>`要素内にあるルビ文字内のみ検索する
3. 要素を跨いで周辺の文字も絡めた検索をする

　HTML、`<ruby>`内のみ、のニパターン検索を終えた場合、さらに追加で要素を跨いだ検索をする。

1. HTMLテキストで検索する
2. `<ruby>`要素個別検索
    1. 親文字のみ
    2. ルビ文字のみ
3. `<ruby>`要素を跨いで周辺の文字も絡めた検索をする

　3は`<ruby>`要素の前後にあるプレーンテキストか要素のtextContent、または`<ruby>`要素なら同様に親文字とルビ文字の２パターンで比較する。

1. 検索文字列と親文字に共通部分があるか判定する
2. 検索文字列とルビ文字に共通部分があるか判定する
3. 上記のいずれかがある場合
    1. `<ruby>`要素の前後にあるものが`<ruby>`要素の場合
        1. 検索文字列と前後要素の`<ruby>`要素の親文字かルビ文字に共通部分があるか判定する
    1. `<ruby>`要素の前後にあるものが`<ruby>`要素以外の要素の場合
        1. 検索文字列と前後要素のtextContentに共通部分があるか判定する
    1. `<ruby>`要素の前後にあるものがプレーンテキストの場合
        1. 検索文字列と前後プレーンテキストに共通部分があるか判定する
4. `<ruby>`要素とその前後に検索文字列との共通部分があった場合
    1. その開始〜終了位置に`<mark>`要素を挿入する

「山田」：❌「やま」までマークされてしまう
```html
あ<ruby><mark>山<rt>やま</rt>田</mark><rt>だ</rt><ruby>い
```

「やまだ」：❌「田」までマークされてしまう
```html
あ<ruby>山<rt><mark>やま</rt>田<rt>だ</mark></rt><ruby>い
```

「あ山」：○
```html
<mark>あ<ruby>山</mark><rt>やま</rt>田<rt>だ</rt><ruby>い
```

「あ山田い」：△「やまだ」までマークされてしまうが、山田に対するルビのため問題とまでは言えないか？
```html
<mark>あ<ruby>山<rt>やま</rt>田<rt>だ</rt><ruby>い</mark>
```

# `title`や`h1`要素でもルビを使いたい

* `title`要素では`textContet`値がそのまま出力されてしまう。
* `h1`要素ではSEO的に不利である（`ruby`要素は`textContet`値として解釈され、意味不明な文章になってしまう）

　上記問題を無視して、強引にルビを振ってみる。

```html
<title data-ruby="ひょうだい｜かんじ｜たい｜ふ">表題にも漢字に対してルビを振りたい</title>
<h1 data-ruby="ひょうだい｜かんじ｜たい｜ふ">表題にも漢字に対してルビを振りたい</h1>
```
```html
<title>表題にも漢字に対してルビを振りたい</title>
<h1>表題にも漢字に対してルビを振りたい</h1>

<!-- title要素では<ruby>が効かない -->
<title><ruby>表題<rt>ひょうだい</rt></ruby>にも<ruby>漢字<rt>かんじ</rt></ruby>に<ruby>対<rt>たい</rt></ruby>してルビを<ruby>振<rt>ふ</rt></ruby>りたい</title>
<!-- ダミーのh1要素で表示する。このとき<h1>はdisplay:noneするなど非表示にする（透明や背景色と同じにする等） -->
<dummy-h1><ruby>表題<rt>ひょうだい</rt></ruby>にも<ruby>漢字<rt>かんじ</rt></ruby>に<ruby>対<rt>たい</rt></ruby>してルビを<ruby>振<rt>ふ</rt></ruby>りたい</h1>
```

* `<h1>`を視覚的に透明化する
    * 人の目には見えない（ルビなしのテキストは見えない）
    * クローラには見える（ルビなしのテキストでSEO判定してくれる）
* `<dummy-h1>`を見せる
    * `<h1>`と同じCSSを適用する

```html
<title></title>
<h1></h1>
```

# ルビを振るとSEOで不利になる問題

　これはもう、どうしようもない。Googleが何とかしてくれるのを待つだけ。

https://support.google.com/webmasters/thread/162548293/%E3%83%AB%E3%83%93%E3%82%92%E6%8C%AF%E3%81%A3%E3%81%9F%E6%96%87%E7%AB%A0%E3%81%AF%E3%80%81google%E3%81%AB%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E7%90%86%E8%A7%A3%E3%81%95%E3%82%8C%E3%82%8B%E3%81%AE%E3%81%A7%E3%81%97%E3%82%87%E3%81%86%E3%81%8B%EF%BC%9F%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%84seo%E4%B8%8A%E3%81%AE%E5%95%8F%E9%A1%8C%E3%81%8C%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%EF%BC%9F?hl=ja


